set dotenv-load

# Lists all available backend commands.
_default:
  @just --list

version := `git describe --tags --always --dirty 2>/dev/null || echo dev`

# Builds the gastrolog binary.
build:
  go build -ldflags "-X main.version={{version}}" -o gastrolog ./cmd/gastrolog

# Runs the gastrolog backend with raft config (default).
run-raft:
  go run ./cmd/gastrolog server --home data

# Runs the gastrolog backend with in-memory config (no persistence).
run-memory:
  go run ./cmd/gastrolog server --config-type memory

alias run := run-raft

# Runs the gastrolog backend with full bootstrap (memory store + chatterbox).
run-bootstrap:
  go run ./cmd/gastrolog server --bootstrap --home data

# Runs the gastrolog backend with authentication disabled (all requests treated as admin).
run-noauth:
  go run ./cmd/gastrolog server --no-auth --home data

# Runs the gastrolog backend with pprof server.
pprof:
  go run ./cmd/gastrolog server --home data --pprof localhost:6060

# Runs a config CLI command against the local server. Usage: just cfg filter list
conf *args:
  go run ./cmd/gastrolog --home data config {{args}}

# Cross-compiles for a specific OS/arch. Usage: just build-cross linux amd64
build-cross os arch:
  CGO_ENABLED=0 GOOS={{os}} GOARCH={{arch}} go build -ldflags "-X main.version={{version}}" -o gastrolog-{{os}}-{{arch}} ./cmd/gastrolog

# Builds release binaries for all supported platforms.
build-all:
  just build-cross linux amd64
  just build-cross linux arm64
  just build-cross darwin amd64
  just build-cross darwin arm64

# Generates Go protobuf code from proto definitions.
gen:
  cd api/proto && buf generate

# Lints Go code (cognitive complexity, cyclomatic complexity, gocritic).
lint:
  golangci-lint run ./...

# Full backend quality audit: lint, vet, race tests, vulnerability scan, dead code.
audit:
  #!/usr/bin/env bash
  set -euo pipefail
  echo "=== golangci-lint ==="
  golangci-lint run ./...
  echo "=== go vet ==="
  go vet ./...
  echo "=== go test -race ==="
  go test -race -count=1 ./...
  echo "=== govulncheck ==="
  go run golang.org/x/vuln/cmd/govulncheck@latest ./...
  echo "=== deadcode ==="
  go run golang.org/x/tools/cmd/deadcode@latest ./...

# --- Cluster development recipes ---

# Removes all cluster node data directories.
cluster-clean:
  rm -rf data/node1 data/node2 data/node3 data/node4 data/cluster-token

# Starts cluster node 1 (leader). Writes join token to data/cluster-token.
cluster-node1:
  #!/usr/bin/env bash
  set -euo pipefail
  mkdir -p data
  # Logs go to stderr; merge into stdout so we can tee and extract the token.
  go run ./cmd/gastrolog server \
    --home data/node1 \
    --addr :4564 \
    --cluster-addr :4565 \
    --cluster-init \
    --bootstrap 2>&1 | while IFS= read -r line; do
      echo "$line" >&2
      if [[ "$line" == *"cluster join token"*"token="* ]]; then
        token="${line##*token=}"
        token="${token%% *}"
        if [[ -n "$token" ]]; then
          echo "$token" > data/cluster-token
          echo ">>> join token saved to data/cluster-token" >&2
        fi
      fi
    done

# Starts cluster node 2 (follower). Requires node 1 to be running.
cluster-node2:
  #!/usr/bin/env bash
  set -euo pipefail
  if [[ ! -f data/cluster-token ]]; then
    echo "error: data/cluster-token not found — start node 1 first (just cluster-node1)"
    exit 1
  fi
  TOKEN=$(cat data/cluster-token)
  exec go run ./cmd/gastrolog server \
    --home data/node2 \
    --addr :4574 \
    --cluster-addr :4575 \
    --join-addr localhost:4565 \
    --join-token "$TOKEN"

# Starts cluster node 3 (follower). Requires node 1 to be running.
cluster-node3:
  #!/usr/bin/env bash
  set -euo pipefail
  if [[ ! -f data/cluster-token ]]; then
    echo "error: data/cluster-token not found — start node 1 first (just cluster-node1)"
    exit 1
  fi
  TOKEN=$(cat data/cluster-token)
  exec go run ./cmd/gastrolog server \
    --home data/node3 \
    --addr :4584 \
    --cluster-addr :4585 \
    --join-addr localhost:4565 \
    --join-token "$TOKEN"

# Starts cluster node 4 (nonvoter). Requires node 1 to be running.
cluster-node4:
  #!/usr/bin/env bash
  set -euo pipefail
  if [[ ! -f data/cluster-token ]]; then
    echo "error: data/cluster-token not found — start node 1 first (just cluster-node1)"
    exit 1
  fi
  TOKEN=$(cat data/cluster-token)
  exec go run ./cmd/gastrolog server \
    --home data/node4 \
    --addr :4594 \
    --cluster-addr :4595 \
    --join-addr localhost:4565 \
    --join-token "$TOKEN" \
    --voteless

# Runs an existing cluster node 1 (no init, no enrollment).
run-node1:
  go run ./cmd/gastrolog server --home data/node1 --addr :4564 --cluster-addr :4565

# Runs an existing cluster node 2 (no init, no enrollment).
run-node2:
  go run ./cmd/gastrolog server --home data/node2 --addr :4574 --cluster-addr :4575

# Runs an existing cluster node 3 (no init, no enrollment).
run-node3:
  go run ./cmd/gastrolog server --home data/node3 --addr :4584 --cluster-addr :4585

# Runs an existing cluster node 4 (nonvoter, no init, no enrollment).
run-node4:
  go run ./cmd/gastrolog server --home data/node4 --addr :4594 --cluster-addr :4595

# Runs all 4 cluster nodes in one terminal with colored output.
cluster-run:
  go run ./cmd/multirun \
    --name node1,node2,node3,node4 \
    "go run ./cmd/gastrolog server --home data/node1 --addr :4564 --cluster-addr :4565" \
    "go run ./cmd/gastrolog server --home data/node2 --addr :4574 --cluster-addr :4575" \
    "go run ./cmd/gastrolog server --home data/node3 --addr :4584 --cluster-addr :4585" \
    "go run ./cmd/gastrolog server --home data/node4 --addr :4594 --cluster-addr :4595"

# --- End cluster recipes ---

# Embeds built frontend assets into the backend (brotli-compressed).
embed-frontend:
  rm -rf internal/frontend/dist/*
  cp -r ../frontend/dist/* internal/frontend/dist/
  go run ./cmd/compress-assets internal/frontend/dist
