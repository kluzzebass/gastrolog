syntax = "proto3";

package gastrolog.v1;

import "gastrolog/v1/cluster.proto";

option go_package = "gastrolog/api/gen/gastrolog/v1;gastrologv1";

// LifecycleService provides server lifecycle management.
service LifecycleService {
  // Health returns the server health status.
  rpc Health(HealthRequest) returns (HealthResponse);

  // Shutdown initiates a graceful shutdown.
  rpc Shutdown(ShutdownRequest) returns (ShutdownResponse);

  // GetClusterStatus returns the current cluster topology and Raft state.
  rpc GetClusterStatus(GetClusterStatusRequest) returns (GetClusterStatusResponse);

  // SetNodeSuffrage promotes or demotes a node's voting status.
  rpc SetNodeSuffrage(SetNodeSuffrageRequest) returns (SetNodeSuffrageResponse);
}

message HealthRequest {}

message HealthResponse {
  Status status = 1;
  string version = 2;
  int64 uptime_seconds = 3;
  int64 ingest_queue_depth = 4;
  int64 ingest_queue_capacity = 5;
}

enum Status {
  STATUS_UNSPECIFIED = 0;
  STATUS_HEALTHY = 1;
  STATUS_DEGRADED = 2;
  STATUS_UNHEALTHY = 3;
}

message ShutdownRequest {
  bool drain = 1; // If true, wait for in-flight requests to complete
}

message ShutdownResponse {}

message GetClusterStatusRequest {}

message GetClusterStatusResponse {
  bool cluster_enabled = 1;
  string leader_id = 2;
  string leader_address = 3;
  repeated ClusterNode nodes = 4;
  RaftStats local_stats = 5;
  string local_node_id = 6;
}

// RaftStats contains Raft consensus statistics for the local node.
// These are derived from the Hashicorp Raft Stats() call and typed methods.
message RaftStats {
  string state = 1;              // "Leader", "Follower", "Candidate", "Shutdown"
  uint64 term = 2;
  uint64 last_log_index = 3;
  uint64 last_log_term = 4;
  uint64 commit_index = 5;
  uint64 applied_index = 6;
  uint64 fsm_pending = 7;
  uint64 last_snapshot_index = 8;
  uint64 last_snapshot_term = 9;
  string last_contact = 10;      // duration since last leader contact (e.g. "12ms", "never")
  uint32 num_peers = 11;
  uint32 protocol_version = 12;
}

message ClusterNode {
  string id = 1;
  string name = 2;
  string address = 3;
  ClusterNodeRole role = 4;
  ClusterNodeSuffrage suffrage = 5;
  bool is_leader = 6;
  NodeStats stats = 7;
}

enum ClusterNodeRole {
  CLUSTER_NODE_ROLE_UNSPECIFIED = 0;
  CLUSTER_NODE_ROLE_LEADER = 1;
  CLUSTER_NODE_ROLE_FOLLOWER = 2;
}

enum ClusterNodeSuffrage {
  CLUSTER_NODE_SUFFRAGE_UNSPECIFIED = 0;
  CLUSTER_NODE_SUFFRAGE_VOTER = 1;
  CLUSTER_NODE_SUFFRAGE_NONVOTER = 2;
  CLUSTER_NODE_SUFFRAGE_STAGING = 3;
}

message SetNodeSuffrageRequest {
  string node_id = 1;
  bool voter = 2; // true = promote to voter, false = demote to nonvoter
}

message SetNodeSuffrageResponse {}
