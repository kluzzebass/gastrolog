syntax = "proto3";
package gastrolog.v1;

import "google/protobuf/timestamp.proto";
import "gastrolog/v1/job.proto";
import "gastrolog/v1/vault.proto";

option go_package = "gastrolog/api/gen/gastrolog/v1;gastrologv1";

// ForwardApplyRequest carries a pre-marshaled ConfigCommand for the leader
// to apply via raft.Apply(). Used by followers to proxy config writes.
message ForwardApplyRequest {
  bytes command = 1;
}

message ForwardApplyResponse {}

// EnrollRequest is sent by a joining node to the cluster leader.
// The token_secret proves the node is authorized to join.
message EnrollRequest {
  string token_secret = 1;
  string node_id = 2;
  string node_addr = 3;
}

// EnrollResponse returns the cluster TLS material to the joining node.
message EnrollResponse {
  bytes ca_cert_pem = 1;
  bytes cluster_cert_pem = 2;
  bytes cluster_key_pem = 3;
}

// BroadcastRequest sends a typed message to a peer node.
message BroadcastRequest {
  BroadcastMessage message = 1;
}

message BroadcastResponse {}

// BroadcastMessage is the envelope for all peer-to-peer broadcast messages.
// The oneof payload makes it extensible â€” new message types are added as
// new variants without breaking existing receivers.
message BroadcastMessage {
  string sender_id = 1;
  google.protobuf.Timestamp timestamp = 2;

  oneof payload {
    NodeStats node_stats = 10;
    NodeJobs node_jobs = 11;
  }
}

// NodeJobs reports active job state for a single cluster node.
// Broadcast periodically and immediately on job completion/failure.
message NodeJobs {
  repeated Job jobs = 1;
}

// NodeStats reports runtime statistics for a single cluster node.
message NodeStats {
  double cpu_percent = 1;
  uint64 memory_inuse = 2;
  uint64 memory_rss = 3;
  uint64 memory_heap_alloc = 4;
  uint64 memory_sys = 5;
  uint32 goroutines = 6;
  uint32 ingest_queue_depth = 7;
  uint32 ingest_queue_capacity = 8;
  repeated VaultStats vaults = 9;
  repeated IngesterNodeStats ingesters = 10;

  // Identity
  string node_name = 11;
  string version = 12;
  string raft_state = 13;
  string suffrage = 14;
  int64 uptime_seconds = 15;

  // Memory detail
  uint64 memory_heap_idle = 16;
  uint64 memory_heap_released = 17;
  uint64 memory_stack_inuse = 18;
  uint64 memory_heap_objects = 19;
  uint32 num_gc = 20;

  // Raft
  uint64 raft_term = 21;
  uint64 raft_commit_index = 22;
  uint64 raft_applied_index = 23;
  string raft_last_contact = 24;
  uint64 raft_fsm_pending = 25;
}

// IngesterNodeStats reports per-ingester statistics on a cluster node.
message IngesterNodeStats {
  string id = 1;
  uint64 messages_ingested = 2;
  uint64 bytes_ingested = 3;
  uint64 errors = 4;
  bool running = 5;
  string name = 6;
}
